Counting Words in Go
Kyoto.go
21 Mar 2021

yebis0942

* è‡ªå·±ç´¹ä»‹

- id:yebis0942
- ä»•äº‹ã§ã¯Railsã‚’ä½¿ã£ã¦ã„ã¾ã™

æœ€è¿‘æ°—ã«ãªã£ãŸãƒ‹ãƒ¥ãƒ¼ã‚¹:

.link https://github.blog/2021-03-16-improving-large-monorepo-performance-on-github/ Improving large monorepo performance on GitHub - The GitHub Blog

> Weâ€™re also in the middle of a significant refactoring effort, doing our part to *decompose* *GitHubâ€™s* *famous* *Ruby* *monolith*, and writing *a* *new* *microservice* *in* *Go* that will improve repository performance for every single user on GitHub.

* ä»Šé€±è¦‹ã¤ã‘ãŸé¢ç™½è¨˜äº‹ã®ç´¹ä»‹ã‚’ã—ã¾ã™

* ä»Šé€±è¦‹ã¤ã‘ãŸè¨˜äº‹

.link https://benhoyt.com/writings/count-words/ Performance comparison: counting words in Python, Go, C++, C, AWK, Forth, and Rust

ã€Œè‹±æ–‡ã®å˜èªã®å‡ºç¾å›æ•°ã‚’æ•°ãˆã¦ã€å‡ºç¾å›æ•°ãŒå¤šã„é †ã«å‡ºåŠ›ã™ã‚‹ã€ã¨ã„ã†èª²é¡Œã‚’ã„ã‚ã„ã‚ãªè¨€èªã§å®Ÿè£…ã—ã¦ã€ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æ”¹å–„ã—ã¦ã¿ãŸã¨ã„ã†è¨˜äº‹ã€‚

* Goå®Ÿè£…ã®æ„å¤–ãªãƒœãƒˆãƒ«ãƒãƒƒã‚¯ã¨ãã®è§£æ¶ˆæ–¹æ³•

* æ”¹å–„å‰ã®å®Ÿè£…ã¨æ”¹å–„å¾Œã®å®Ÿè£…ã®å·®åˆ†

.link https://github.com/benhoyt/countwords/blob/49a30699e63d99d1c2799c7b1b36ea5351190b6e/simple.go simple.go

.link https://github.com/benhoyt/countwords/blob/49a30699e63d99d1c2799c7b1b36ea5351190b6e/optimized.go optimized.go

.link https://gist.github.com/vzvu3k6k/2cf4a43ddaaccaafb046d50ebcfb0d27#file-go-diff ä¸¡è€…ã®å·®åˆ†

* map[string]*intâ€¦?

.link https://gist.github.com/vzvu3k6k/2cf4a43ddaaccaafb046d50ebcfb0d27#file-go-intptr-diff å·®åˆ†

>To reduce the allocations, weâ€™ll use a `map[string]*int` instead of `map[string]int` so we only have to allocate once per unique word, instead of for every increment

* ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯çµæœ

  $ ./benchmark.py
  Timing Go 0.61 0.39
  
  Language      | Simple | Optimized | Notes
  ------------- | ------ | --------- | -----
  Go            |   0.61 |      0.39 |

`Simple` ãŒ `map[string]int` ç‰ˆã§ã€ `Optimized` ãŒ `map[string]*int` ç‰ˆã€‚

ãªãœã‹ `map[string]int` ã‚ˆã‚Š `map[string]*int` ã®ã»ã†ãŒæ—©ã„ã€‚

* pprofã§è¦‹ã¦ã¿ã‚‹ã¨

  $ go tool pprof -top cpuprofile.simple
  Duration: 808.30ms, Total samples = 610ms (75.47%)
  Showing nodes accounting for 610ms, 100% of 610ms total
        flat  flat%   sum%        cum   cum%
       250ms 40.98% 40.98%      250ms 40.98%  syscall.syscall
        90ms 14.75% 55.74%      140ms 22.95%  runtime.mapassign_faststr <-- ğŸ‘€
        40ms  6.56% 62.30%      490ms 80.33%  main.main
        40ms  6.56% 68.85%       40ms  6.56%  runtime.madvise
        30ms  4.92% 73.77%       40ms  6.56%  runtime.mallocgc

  $ go tool pprof -top cpuprofile.optimized
  Duration: 613.82ms, Total samples = 390ms (63.54%)
  Showing nodes accounting for 390ms, 100% of 390ms total
        flat  flat%   sum%        cum   cum%
       300ms 76.92% 76.92%      300ms 76.92%  syscall.syscall
        20ms  5.13% 82.05%      370ms 94.87%  main.main
        20ms  5.13% 87.18%       30ms  7.69%  runtime.mapaccess2_faststr <-- ğŸ‘€
        10ms  2.56% 89.74%       50ms 12.82%  main.increment (inline)
        10ms  2.56% 92.31%       10ms  2.56%  memeqbody

* ã©ã†ã„ã†ã“ã¨ãªã®ã‹

[[https://news.ycombinator.com/item?id=26466371][HackerNews]]ã¨ã‹[[https://lobste.rs/s/3byl7t/performance_comparison_counting_words#c_hv9zcp][Lobsters]]ã§ã‚‚ã€Œé€Ÿåº¦å·®ãŒå‡ºã‚‹ç†ç”±ãŒã‚ã‹ã‚‰ã‚“â€¦ã€ã¨è¨€ã‚ã‚Œã¦ã„ã‚‹ã€‚

[[https://github.com/golang/go/issues/45021][golang/go#45021]]ã®è§£èª¬ãŒæ­£ã—ã„ã‚ˆã†ã«æ€ãˆã‚‹ã€‚


ğŸ‘‰ ãƒã‚¤ãƒ³ã‚¿ç‰ˆã§ã¯ã€å‡¦ç†ç³»ã«ã‚ˆã‚‹æœ€é©åŒ–ãŒåŠ¹ã„ã¦ã€`map` ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã¨ãã® `string(word)` ã‚’ãƒ¡ãƒ¢ãƒªç¢ºä¿ãªã—ã§å®Ÿè¡Œã—ã¦ãã‚Œã‚‹

  var v []byte
  s = string(v) // æ™®é€šã¯ãƒ¡ãƒ¢ãƒªç¢ºä¿ã•ã‚Œã‚‹

  var m map[string]int
  _ = m[string(v)] // mapã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã¨ãã¯æœ€é©åŒ–ãŒåŠ¹ã„ã¦ãƒ¡ãƒ¢ãƒªç¢ºä¿ã•ã‚Œãªã„
  

* ã‚‚ã†ã¡ã‚‡ã£ã¨è©³ã—ã

1. `counts[string(word)]` ã§mapã®å€¤ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã¨ãã«ã¯ã€ãƒ¡ãƒ¢ãƒªç¢ºä¿ãªã—ã§ `[]bytes` ã‚’ `string` ã«å¤‰æ›ã™ã‚‹æœ€é©åŒ–ãƒ‘ã‚¹ã‚’é€šã‚‹ã€‚
2. `counts[string(word)]++` ã®ã‚ˆã†ã«mapã«å¯¾ã™ã‚‹ä»£å…¥å‡¦ç†ã‚’å‘¼ã³å‡ºã—ãŸã¨ãã«ã¯ã€æ–°ã—ãã‚­ãƒ¼ã‚’è¿½åŠ ã™ã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹ã®ã§ã€ãƒ¡ãƒ¢ãƒªç¢ºä¿ã—ã¦ `[]bytes` ã‚’ `string` ã«å¤‰æ›ã™ã‚‹ã€‚

  var m map[string]int
  _ = m[string(v)] // 1
  m[string(v)]++   // 2

* ãƒã‚¤ãƒ³ã‚¿ä½¿ã‚ãšã«å›é¿ã§ããªã„ã®ã‹ï¼Ÿ

- ç¾çŠ¶ã®å®Ÿè£…ã§ã¯ç„¡ç†ã‹ã‚‚
- `map[string]int` ã«å¯¾ã™ã‚‹ä»£å…¥å‡¦ç†ã§ãƒ¡ãƒ¢ãƒªç¢ºä¿ãŒèµ·ããªã„ãƒ‘ã‚¹ã¯ãªã„ã®ã§ã¯
